<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stepaway Queue</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 2rem; display: grid; place-items: center; min-height: 100vh; }
      .card { max-width: 680px; width: 100%; border: 1px solid #e5e7eb22; border-radius: 12px; padding: 2rem; backdrop-filter: blur(6px); }
      h1 { margin-top: 0; }
      label { display: block; margin: 0.5rem 0 0.25rem; }
      input, select, button { width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #d1d5db88; }
      button { cursor: pointer; background: #2563eb; color: white; border: none; margin-top: 1rem; }
      .muted { color: #6b7280; font-size: 0.9rem; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
      @media (max-width: 640px) { .row { grid-template-columns: 1fr; } }
      .success { background: #10b98122; border: 1px solid #10b98144; color: #065f46; padding: 0.75rem; border-radius: 8px; margin-top: 1rem; display: none; }
      .error { background: #ef444422; border: 1px solid #ef444444; color: #7f1d1d; padding: 0.75rem; border-radius: 8px; margin-top: 1rem; display: none; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Welcome to Stepaway</h1>
      <p class="muted">Join the queue by entering your name and selecting a service. This is a minimal placeholder UI. API URL is discovered automatically.</p>

      <div class="row">
        <div>
          <label for="name">Your name</label>
          <input id="name" placeholder="Alex" />
        </div>
        <div>
          <label for="service">Service</label>
          <select id="service">
            <option value="general">General</option>
            <option value="billing">Billing</option>
            <option value="support">Support</option>
          </select>
        </div>
      </div>

      <button id="join">Join Queue</button>
      <div id="msg" class="success">You're in! We'll display your ticket number here soon.</div>

      <p class="muted">Health check: <span id="health">checking...</span></p>
    </div>

    <div class="card" style="margin-top: 1rem;">
      <h2>Staff</h2>
      <p class="muted">If you are a staff member, you can sign in to manage your queue and create a business profile.</p>
      <div class="row">
        <a id="staffLink" href="./staff.html"><button>Staff Login</button></a>
        <a id="createBizLink" href="./staff.html"><button>Create a Business</button></a>
      </div>
      <p class="muted">Tip: the staff console will use the API base URL if you configured it here.</p>
    </div>

    <script>
      const API_BASE = localStorage.getItem('STEP_API') || new URLSearchParams(location.search).get('api') || '';
      const BIZ_ID = localStorage.getItem('STEP_BIZ') || new URLSearchParams(location.search).get('biz') || '';
      // Persist API base and biz id from query params for convenience
      (function persistFromQuery(){
        const qs = new URLSearchParams(location.search);
        const apiFromQuery = qs.get('api');
        const bizFromQuery = qs.get('biz');
        if (apiFromQuery) localStorage.setItem('STEP_API', apiFromQuery);
        if (bizFromQuery) localStorage.setItem('STEP_BIZ', bizFromQuery);
      })();
      // Build staff links carrying API base if known
      (function buildStaffLinks(){
        const staff = document.getElementById('staffLink');
        const create = document.getElementById('createBizLink');
        function withApi(url){
          if (!API_BASE) return url;
          const u = new URL(url, location.href);
          u.searchParams.set('api', API_BASE);
          return u.toString();
        }
        if (staff) staff.href = withApi('./staff.html');
        if (create) create.href = withApi('./staff.html');
      })();
      async function api(path, init) {
        if (!API_BASE) return { error: 'No API URL configured. Append ?api=https://your-api.execute-api.* to the URL.' };
        try {
          const res = await fetch(API_BASE.replace(/\/$/, '') + path, { ...init, headers: { 'content-type': 'application/json', ...(init && init.headers) } });
          const json = await res.json().catch(() => ({}));
          return { status: res.status, ok: res.ok, json };
        } catch (e) { return { error: e && e.message ? e.message : String(e) }; }
      }

      document.getElementById('join').addEventListener('click', async () => {
        const name = document.getElementById('name').value.trim();
        const service = document.getElementById('service').value;
        const msg = document.getElementById('msg');
        msg.className = 'success';
        msg.style.display = 'none';
        if (!name) {
          msg.className = 'error';
          msg.textContent = 'Please enter your name.';
          msg.style.display = 'block';
          return;
        }
        if (!BIZ_ID) {
          msg.className = 'error';
          msg.textContent = 'Missing business ID. Use a QR or URL with ?biz=<businessId>.';
          msg.style.display = 'block';
          return;
        }
        const res = await api(`/b/${encodeURIComponent(BIZ_ID)}/enqueue`, { method: 'POST', body: JSON.stringify({ name, service }) });
        if (res.ok) {
          msg.style.display = 'block';
          const ticket = res.json && (res.json.ticketId || res.json.id);
          msg.textContent = ticket ? `Joined! Ticket ${ticket} pending — full flow coming soon.` : 'Joined! Ticket pending — full flow coming soon.';
        } else {
          const detail = res.error || (res.json && (res.json.message || JSON.stringify(res.json))) || 'unknown error';
          msg.className = 'error';
          msg.textContent = 'Failed: ' + detail;
          msg.style.display = 'block';
        }
      });

      (async () => {
        const el = document.getElementById('health');
        const res = await api('/health');
        if (res && res.ok) el.textContent = 'online'; else el.textContent = 'unavailable';
      })();
    </script>
  </body>
</html>
